# 数据孤岛项目总设计图 (2025-11-18)

> **本文档是项目的"水电暖图"** - 通过索引快速定位所有文件、代码、配置和进展信息，无需阅读所有文件即可找到所需内容。

**文档版本**: v2.2  
**创建日期**: 2025-11-18  
**最后更新**: 2025-11-19  
**项目周期**: 1周（2025-11-18 至 2025-11-25）

---

## 📑 快速导航索引

### 🎯 项目目标与原则
- [项目目标](#项目目标)
- [工作原则](#工作原则)
- [成功标准](#成功标准)

### 📊 数据资产索引
- [四个数据库概览](#四个数据库概览)
- [原始数据位置](#原始数据位置索引)
- [清洗后数据位置](#清洗后数据位置索引)
- [字典文件位置](#字典文件位置索引)

### 🏗️ 项目结构索引
- [目录结构](#项目目录结构)
- [代码库索引](#代码库索引)
- [配置文件位置](#配置文件位置)

### 🔧 环境配置索引
- [开发环境](#开发环境配置)
- [数据库配置](#数据库配置)
- [工具与依赖](#工具与依赖)

### 📚 文档索引
- [备忘录文件](#备忘录文件索引)
- [报告文件](#报告文件索引)
- [工作流程文档](#工作流程文档)

### 🚀 执行计划
- [一周执行计划](#一周执行计划)
- [任务清单](#任务清单)

---

## 🎯 项目目标

### 核心目标
1. **数据一致性验证**: 核对四个数据库（NC、TB、销售、生产）的原始文件与清洗后文件的一致性
2. **字典工程完善**: 核对并完善产品字典和经销商字典，实现高覆盖率（目标95%+）
3. **数据库连接**: 通过字典工程实现四个数据库的最终连接，形成统一的"数据库"
4. **知识体系建立**: 保存环境配置、代码、工作流程、提示词工程等，建立可复用的"地基和图纸"

### 工作原则
- **不急于完成目标，而是建立完整的基础设施**
- **注重过程记录和知识沉淀**
- **建立可复用的工作流程**
- **学会人机协作的最佳实践**

---

## 📊 四个数据库概览

| 数据库 | 角色 | 原始数据位置 | 清洗后数据位置 | 关键字段 | 当前状态 | 数据库名称 |
|--------|------|-------------|---------------|----------|----------|-----------|
| **NC_20250902** | 财务库（商流） | `原始数据/NC报表/NC-所有销售订单/` | `清洗后数据/NC-所有销售订单2022-2024.csv` | `物料名称` | ✅ 已验证 | CSV文件 |
| **TB_Restored** | 溯源业务库（实物流） | SQL Server备份(.bak) | 数据库形式 | `ProductName` | ✅ 已验证连接 | `TB_Restored` (业务库)<br>`TBJD_Restored` (定义库) |
| **Sales_DB** | 销售报表库 | `原始数据/销售报表/宝成-*.xlsx` | `清洗后数据/sales_*.csv` | `产品名称` | ⚠️ 验证中 | CSV文件 |
| **Production_DB** | 生产汇总库 | `原始数据/生产报表/生产数据.xlsx` | `清洗后数据/production_*.csv` | `产品名称` | ✅ 已验证 | CSV文件 |

### 数据库详细说明

#### NC_20250902 (财务库)
- **关键表**: `SalesOrders` (CSV格式，只关注销售订单)
- **数据特点**: 产品范围远大于核心产品，包含大量非酒类物料
- **数据源**: `22-24nc销售订单汇总(只有酒).csv` (只包含主单位为"瓶"的记录)
- **清洗后数据**: `NC-所有销售订单2022-2024.csv` (33,459条记录，2022-2024年)
- **验证状态**: ✅ 已完成验证，文件一致性100%
- **说明**: 项目只关注销售订单，不关注出库订单

#### TB_Restored (溯源业务库) - **已更新**
- **数据库名称**: `TB_Restored` (业务库), `TBJD_Restored` (定义库)
- **关键表**: 
  - `TB_Restored.dbo.TBProduct` (产品表，225条记录) ✅
  - `TB_Restored.dbo.TBOut` (出库主表，70,729条记录) ✅
  - `TB_Restored.dbo.TBIn` (入库主表，1,529条记录) ✅
  - `TB_Restored.dbo.TBCustomer` (经销商表，1,561条记录) ✅
- **关键字段**: 
  - `TBOut.ThreeLevelCount` (出库瓶数)
  - `TBInCodeRelation.ChildCount` (Level=2时为入库瓶数)
- **关联关系**: 
  - `TBOut.ToCustomerId = TBCustomer.CustomerId` (经销商关联)
  - `TBOut.ProductId = TBProduct.ProductId` (产品关联)
- **验证状态**: ✅ 数据库连接成功，表结构已验证
- **参考文档**: `孤岛备份文件/备用/其他/数据库备忘录（20250817).md`

#### Sales_DB (销售报表库)
- **数据量**: 
  - 正常订单: 17,436条 (2022-2024)
  - 支持订单: 13,097条 (2022-2024)
- **验证状态**: ⚠️ 验证中，发现不一致需要分析

#### Production_DB (生产汇总库)
- **数据特点**: 记录入库和出库信息
- **验证状态**: ✅ 已验证（时间范围完整，2022-2024年）

---

## 📁 项目目录结构

```
/Users/ozzymini/Documents/孤岛-mini/
├── 原始数据/                    # 所有原始数据文件
│   ├── NC报表/
│   ├── 生产报表/
│   └── 销售报表/
├── 清洗后数据/                  # 所有清洗后的CSV文件
│   ├── NC-所有销售订单2022-2024.csv  # NC销售订单（2022-2024年，33,459条）
│   ├── NC-所有出库订单2022-2024.csv  # NC出库订单（已筛选2022-2024年，76,120条）
│   ├── sales_normal_orders_2022-2024_final.csv  # 销售正常订单
│   ├── sales_support_orders_2022-2024_final.csv  # 销售支持订单
│   └── production_outbound_2022-2024_final.csv  # 生产出库数据
├── 字典/                        # 产品字典和经销商字典
│   ├── unified_product_dictionary_corrected_v2.csv
│   ├── TB产品名称列表.csv       # 从TB数据库提取
│   ├── TB经销商名称列表.csv     # 从TB数据库提取
│   └── 产品名称原始素材/
├── 代码/                        # 项目代码库
│   ├── data_cleaning/           # 数据清洗模块 ✅
│   ├── data_verification/       # 数据验证模块 ✅
│   ├── dictionary/             # 字典处理模块（待创建）
│   └── query/                  # 查询模块 ✅
├── 备忘录/                      # 项目文档
│   ├── 项目重启总体方案-20251118.md  # 本文档（总设计图）
│   ├── 孤岛清洗-20251118.md     # 数据清洗备忘录
│   ├── 数据孤岛备忘录-总.md     # 项目总备忘录
│   └── 11.12字典调整备忘录.md   # 字典调整记录
├── 报告/                        # 验证报告和输出
│   ├── NC数据一致性报告.json/.md
│   ├── 生产数据一致性报告.json/.md
│   ├── 销售数据一致性报告_*.json/.md
│   └── TB数据库验证报告_*.json
├── 工作流程/                    # 工作流程文档（待创建）
├── 环境配置/                    # 环境配置和依赖
│   └── requirements.txt         # Python依赖包
└── venv/                        # Python虚拟环境
```

---

## ⚙️ 开发环境配置

### 数据库配置

#### Docker容器
- **容器名**: `mssql-server` ✅ 正在运行
- **镜像**: `mcr.microsoft.com/mssql/server:2022-latest`
- **连接参数**:
  - Server: `localhost,1433` 或 `12.0.0.1,1433`
  - User: `sa`
  - Password: `MyNewPass123`
- **数据库名称** (已更新):
  - `TB_Restored` (业务库) ✅
  - `TBJD_Restored` (定义库) ✅
  - `NC_20250902` (财务库，CSV格式)

#### macOS ODBC驱动
- **驱动**: `msodbcsql17`
- **安装命令**: `HOMEBREW_ACCEPT_EULA=Y brew install msodbcsql17 mssql-tools`
- **依赖**: `unixodbc`

#### 连接工具
- **Azure Data Studio**: macOS数据库管理
- **SQL Server Management Studio (SSMS)**: Windows数据库管理
- **sqlcmd**: 命令行工具（需添加`-C`和`-N`参数）

### Python环境
- **虚拟环境**: `venv/` (已创建)
- **依赖包**: `环境配置/requirements.txt`
- **关键库**: `pandas`, `pyodbc`, `openpyxl`, `sqlalchemy`, `pyyaml`

### 工具与依赖
- **Gemini CLI**: `/Users/ozzymini/Documents/孤岛-mini/gemini_data_analyst/gda.py`
- **Homebrew**: macOS包管理器

---

## 📚 备忘录文件索引

### 主备忘录
1. **项目重启总体方案-20251118.md** (本文档)
   - **位置**: `备忘录/项目重启总体方案-20251118.md`
   - **用途**: 总设计图，项目索引

2. **孤岛清洗-20251118.md**
   - **位置**: `备忘录/孤岛清洗-20251118.md`
   - **用途**: 数据清洗和整合工作的唯一信息来源

3. **数据孤岛备忘录-总.md**
   - **位置**: `备忘录/数据孤岛备忘录-总.md`
   - **用途**: 项目总备忘录（最后更新2025-11-06）

4. **11.12字典调整备忘录.md**
   - **位置**: `备忘录/11.12字典调整备忘录.md`
   - **用途**: 字典调整记录

### 备份文件中的备忘录
5. **数据库备忘录（20250811）.md**
   - **位置**: `/Users/ozzymini/Documents/孤岛备份文件/备用/其他/数据库备忘录（20250811）.md`
   - **用途**: TB数据库结构详解（2025-08-11版本）

6. **数据库备忘录（20250817).md**
   - **位置**: `/Users/ozzymini/Documents/孤岛备份文件/备用/其他/数据库备忘录（20250817).md`
   - **用途**: TB数据库结构详解（2025-08-17更新版）
   - **关键内容**: TB_Restored数据库的正确表结构和关联关系

7. **WSL Ubuntu 环境配置与网络排错备忘录.md**
   - **位置**: `/Users/ozzymini/Documents/孤岛备份文件/备用/其他/WSL Ubuntu 环境配置与网络排错备忘录.md`
   - **用途**: WSL环境配置（Windows系统参考）

---

## 🚀 一周执行计划

### Day 1-2 (11/18-11/19): 文件完整性检查与项目结构确认 ✅
- ✅ 核对四个数据库的原始文件和清洗后文件清单
- ✅ 从备份文件迁移数据清洗模块
- ✅ 整理查询脚本
- ✅ 生成文件完整性检查报告
- ✅ 建立项目结构规范文档

### Day 3-4 (11/19-11/20): 数据一致性核对 ✅
- ✅ 开发数据一致性核对脚本
- ✅ 执行数据一致性验证
- ✅ 生成一致性报告
- ✅ 生产数据核对修复（匹配率100%）
- ✅ NC数据源切换和年份筛选
- ✅ 销售订单与出库订单差异分析
- ✅ NC销售订单数据生成
- ✅ 总路线图完整性检查
- ✅ 字典工程文件清单准备

### Day 5-6 (11/20-11/21): 字典工程核对与完善
- [ ] 确认字典文件（产品字典、经销商字典）
- [ ] 运行字典分析脚本，获取最新覆盖率
- [ ] 分析未匹配的产品/经销商
- [ ] 补充缺失产品到字典
- [ ] 补充缺失经销商到字典
- [ ] 建立产品名称映射规则
- [ ] 重新评估覆盖率（目标95%+）

### Day 7 (11/23-11/25): 数据库连接与知识体系建立
- [ ] 开发字典应用脚本
- [ ] 开发跨数据源查询引擎
- [ ] 整理环境配置文档
- [ ] 更新主备忘录

---

## ✅ 当前进展状态

### 已完成 ✅
1. **项目结构建立**: 目录结构已标准化
2. **代码迁移**: 数据清洗模块已迁移并验证
3. **NC数据验证**: ✅ 已完成（匹配率86.65%）
4. **生产数据验证**: ✅ 已完成（匹配率100%）
5. **TB数据库验证**: ✅ 连接成功，表结构已验证
6. **销售数据验证**: ✅ 已完成（匹配率97.64%）
7. **生产数据核对修复**: ✅ 月份提取逻辑已修复
8. **NC数据源切换**: ✅ 已切换为销售订单汇总文件
9. **NC销售订单数据生成**: ✅ 已生成新的清洗后数据文件
10. **总路线图完整性检查**: ✅ 完整性评分100%
11. **字典工程文件清单**: ✅ 已准备文件清单

### 进行中 ⚠️
1. **字典工程核对与完善**: Day 5-6任务（明天开始）

### 待完成
1. **字典工程完善**: Day 5-6任务
2. **数据库连接**: Day 7任务

---

## 🔗 快速参考链接

### 关键文件路径
- **总设计图**: `备忘录/项目重启总体方案-20251118.md` (本文档)
- **主备忘录**: `备忘录/孤岛清洗-20251118.md`
- **产品字典**: `字典/unified_product_dictionary_corrected_v2.csv`
- **经销商字典**: `字典/经销商名称原始素材/master_dealer_list.csv`
- **TB产品列表**: `字典/TB产品名称列表.csv` ✅ 已生成
- **TB经销商列表**: `字典/TB经销商名称列表.csv` ✅ 已生成

### 关键代码位置
- **数据清洗模块**: `代码/data_cleaning/` ✅
- **数据验证模块**: `代码/data_verification/` ✅
- **查询模块**: `代码/query/` ✅

### 关键配置
- **数据库连接**: Server=`localhost,1433`, User=`sa`, Password=`MyNewPass123`
- **Docker容器**: `mssql-server` ✅ 正在运行
- **数据库名称**: `TB_Restored`, `TBJD_Restored` ✅ 已确认

---

**文档维护**: 本文档应在项目执行过程中持续更新，确保索引信息的准确性和完整性。

**最后更新**: 2025-11-19  
**更新内容**: 
- 更新NC数据源为销售订单（而非出库订单）
- 添加新生成的清洗后数据文件索引
- 更新清洗后数据位置索引
- 创建代码库和清洗后数据的README索引
- 更新Day 3-4任务完成状态
- 更新Day 5-6任务计划

**工作日志**: 详见 `备忘录/工作日志-20251119.md`

