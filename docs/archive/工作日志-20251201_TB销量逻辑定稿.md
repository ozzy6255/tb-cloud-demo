# 工作日志 - 2025-12-01 (TB 销量统计逻辑最终定稿)

**日期**: 2025-12-01
**重点**: 确立 TB 系统销量的最终统计口径

---

## 🔄 业务逻辑重构

经过反复核实，我们明确了 TB 系统中各实体的业务属性：

1.  **平台公司 (内部节点)**:
    *   `君顶国际酒业（山东）有限公司`
    *   `济南君顶酒业有限公司`
    *   **性质**: 它们视同公司的**仓库/中转站**。它们从工厂拿货属于**内部调拨**，不计入销售业绩。

2.  **经销商 (外部节点)**:
    *   **定义**: 除上述两家平台公司以外的所有客户。
    *   **性质**: 真正的买家。货物流入它们手中，才视为**有效销售**。

---

## 📐 销量统计公式 (The Golden Rule)

为了准确计算公司的**真实对外销量**，并彻底避免重复计算，我们确立以下统计规则：

> **有效销量 = 所有发给“非平台经销商”的正常出库记录**

**SQL 逻辑**:
```sql
SELECT SUM(ThreeLevelCount)
FROM TBOut
WHERE OutType = 0  -- 排除退货
  AND ToCustomerId NOT IN (
      'e99508bb-d744-475b-a02c-95b2c681861c', -- 君顶国际酒业（山东）有限公司
      '0559208e-5dc3-4efb-a23e-3d926a109648'  -- 济南君顶酒业有限公司
  )
```

**逻辑闭环验证**:
*   **工厂 -> 平台**: `To=平台`，**不计入** (正确，属调拨)。
*   **平台 -> 经销商**: `To=经销商`，**计入** (正确，属销售)。
*   **工厂 -> 经销商**: `To=经销商`，**计入** (正确，属直销)。

此公式同时覆盖了直销和分销两种模式，且完美规避了重复计算。

---

## 📝 下一步行动

基于此逻辑，我们将编写产销分析脚本，对比：
1.  **生产量**: 工厂入库量。
2.  **TB销量**: 上述公式计算出的对外发货量。
3.  **销售报表销量**: 财务端记录的销量。

