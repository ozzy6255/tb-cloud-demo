# 数据孤岛清洗备忘录 (2025-11-18)

**目标**: 本文档旨在统一、整理和记录项目的所有关键信息，作为数据清洗和整合工作的唯一信息来源 (Single Source of Truth)。

---

## 1. 总目标

整合并验证分散的数据源（NC、TB、销售、生产），以“字典”为核心，通过数据核对的方式进行连接，最终形成一个整体的、可用的、能够提供“相对准确”数据的统一数据库。

---

## 2. 数据资产盘点 (Data Asset Inventory)

### 2.1. 销售数据 (Sales)

*   **数据角色**: 核心业务数据，记录经销商的销售情况。
*   **原始数据**:
    *   **位置**: `原始数据/销售报表/宝成-*.xlsx`
    *   **格式**: Excel (.xlsx)，格式高度不规范。
*   **清洗后数据**:
    *   **位置**: `清洗后数据/销售报表/`
        *   `normal_orders_all_2022-2024.csv`
        *   `support_orders_all_2022-2024.csv`
    *   **格式**: CSV
*   **数据量**:
    *   `normal_orders_all_2022-2024.csv`: **17,436** 条记录。
    *   `support_orders_all_2022-2024.csv`: **13,097** 条记录。
*   **关键字段**: `订单日期`, `产品名称`, `数量`, `金额`, `系统编号`, `备注`。
*   **已知问题与状态**:
    *   原始Excel文件格式混乱（合并单元格、多表头等），是清洗工作的主要挑战。
    *   清洗后的CSV与原始数据一致性达95%以上。
    *   产品字典覆盖率为100%（针对已标记产品），但仍有约10-15个真实产品未被收录在字典中。
    *   **2025-11-27补充**: `礼盒(T50白)` 与 `礼盒(T50红)` 在销售系统中确认属于关联品（包装配件），不计入酒类销量。所有T50统计及字典映射需明确排除，详见 `报告/礼盒T50白红_销售明细.csv`。

### 2.2. 生产数据 (Production)

*   **数据角色**: 记录产品的生产入库与出库信息。
*   **原始数据**:
    *   **位置**: `原始数据/生产报表/生产数据.xlsx`
    *   **格式**: Excel (.xlsx)
*   **清洗后数据**:
    *   **位置**: `/Users/ozzymini/Documents/孤岛备份文件/备用/`
        *   `production_inbound_2022-2024_final.csv`
        *   `production_outbound_2022-2024_final.csv`
    *   **格式**: CSV
*   **数据量**:
    *   2024年1月入库量为 **280,175** 瓶 (仅为示例，非总量)。
*   **关键字段**: `产品名称`, `数量`等。
*   **已知问题与状态**:
    *   原始数据表头结构不一致。
    *   产品字典覆盖率为88.9%，约有10个真实产品未被收录在字典中。

### 2.3. NC (财务) 数据

*   **数据角色**: 财务系统数据，记录商流。
*   **原始数据**:
    *   **位置**: `原始数据/NC报表/`
    *   **格式**: CSV
*   **数据库**:
    *   **名称**: `NC_20250902`
    *   **关键表**: `SalesOrders`, `OutboundOrders`
*   **关键字段**: `物料名称`。
*   **已知问题与状态**:
    *   产品范围远大于核心产品，包含大量非酒类物料。
    *   客户数据曾存在空格、空值等质量问题。
    *   产品字典覆盖率为100%（针对已标记产品），是目前最准确的数据源。
    *   数据库连接存在问题，待解决。

### 2.4. TB (溯源) 数据

*   **数据角色**: 溯源系统，记录实物流。
*   **原始数据**:
    *   **位置**: `/Users/ozzymini/Downloads/数据库备份/`
    *   **格式**: SQL Server 备份 (.bak)
*   **数据库**:
    *   **名称**: `tb_restored` (业务库), `tbjd_restored` (定义库)
    *   **关键表**: `TBProduct`
*   **关键字段**: `ProductName`。
*   **已知问题与状态**:
    *   产品名称不规范（如缺少“葡萄酒”后缀），导致字典匹配率低（仅52.5%）。
    *   数据库连接存在问题，待解决。

#### 2.4.1. TB 数据库结构与查询详解 (2025-11-18 新增)

通过对 `孤岛备份文件` 中 `数据库备忘录（20250817).md` 和 `数据库备忘录（20250811）.md` 的研究，获得了关于TB数据库结构和查询方式的决定性信息。

**核心发现:**

1.  **存在两个产品表**:
    *   `TBJD20050706.dbo.TBProduct`: 定义库中的产品表，数据可能不完整或非最新。
    *   `TB20050706.dbo.TBProduct`: **业务库中的产品表，这是实际在出入库记录中使用的正确产品表。**

2.  **经销商信息**:
    *   真实的经销商名称存储在 `TB20050706.dbo.TBCustomer` 表中。

3.  **关键表与关联逻辑**:
    *   **出库主表**: `TB20050706.dbo.TBOut`
    *   **产品关联**: `TBOut.ProductId = TBProduct.ProductId`
    *   **经销商关联**: `TBOut.ToCustomerId = TBCustomer.CustomerId` (两者均为GUID格式)

4.  **关键字段**:
    *   **出库数量 (瓶)**: `TBOut.ThreeLevelCount`
    *   **出库时间**: `TBOut.OutTime`
    *   **入库数量 (瓶)**: 需要通过 `TBIn` 和 `v_AllInCodeRelations` 视图，对 `Level=2` 的 `ChildCount` 求和来计算。

**结论**: 所有关于TB数据库的出库查询，都应以 `TB20050706` 业务库为准，并使用上述的表和关联逻辑。

**出库查询示例 (用于查询特定时间段的出库品种、数量、经销商):**
```sql
SELECT
    p.ProductName AS '产品名称',
    c.CustomerName AS '经销商名称',
    o.ThreeLevelCount AS '出库数量',
    o.OutTime AS '出库时间'
FROM
    TB20050706.dbo.TBOut AS o
JOIN
    TB20050706.dbo.TBProduct AS p ON o.ProductId = p.ProductId
JOIN
    TB20050706.dbo.TBCustomer AS c ON o.ToCustomerId = c.CustomerId
WHERE
    o.OutTime BETWEEN '2024-01-01' AND '2024-01-31' -- 以2024年1月为例
ORDER BY
    o.OutTime DESC;
```

#### 2.4.2. TB数据库产品验证结论 (2025-11-27 新增)

**重要发现**: 通过T50产品的详细核对工作，确认了以下关键信息：

1. **TB数据库产品性质验证**:
   - ✅ **TB数据库中的所有产品都是"酒"（需要的产品），而不是酒的关联品（不需要的产品）**
   - 验证方法：通过查询TBOut表中的出库记录，检查产品的完整信息（产品规格、包装规格、出库数量等）
   - 验证范围：已对T50产品进行完整验证，所有7个TB独有产品均为酒类产品
   - **结论**: 后续产品核对工作中，TB数据库中的产品可以直接认定为需要的产品，无需重复验证是否为关联品

2. **验证记录**:
   - 验证时间: 2025-11-27
   - 验证产品: T50系列产品（7个TB独有产品）
   - 验证文件: `报告/TB独有T50产品完整记录.csv` 和 `报告/TB独有T50产品完整记录.md`
   - 验证结果: 所有产品均为酒类产品，包含完整的产品规格、包装规格等信息

3. **工作流程优化**:
   - 在后续产品核对工作中，可以跳过TB数据库产品的"是否为关联品"验证步骤
   - 直接进行产品名称映射和字典更新工作
   - 节省无效、重复的验证工作

---

## 3. 字典系统状态

### 3.1. 产品字典
*   **主字典文件**: `字典/unified_product_dictionary_corrected_v2.csv`
*   **用途**: 统一各数据源的产品名称。
*   **字段**: `Master_Optimized_Name`, `In_NC`, `In_TB`, `In_Sales`, `In_Production`, `NC_Raw_Names`, `TB_Raw_Names`, `Sales_Raw_Names`, `Production_Raw_Names` 等。

#### 待补充到产品字典的真实产品 (约20-25个)
*   **来自销售数据**:
    1.  君顶干红22
    2.  小芒森18, 小芒森20
    3.  天悦干红17
    4.  22尊悦干白
    5.  大唐春干红(3L)
    6.  何尊干红(1.5L), 何尊干红(3L)
    7.  天悦3升VIP私藏
    8.  白鹭干红
    9.  千禧干白
    10. 君顶优选级干白24, 东方优选级干白24
*   **来自生产数据**:
    1.  荣品干红
    2.  严选32红
    3.  元年干红A款, 元年干红B款
    4.  白鹭
    5.  T98干红
    6.  白兰地
    7.  耀系列
    8.  1545
    9.  马瑟兰

### 3.2. 经销商字典 (名称字典)
*   **主字典文件**: `字典/经销商名称原始素材/master_dealer_list.csv`
*   **待办事项**: 主字典缺少销售报表中的结构信息（区域、省份等），需要从 `字典/经销商名称原始素材/销售-经销商名称.csv` 文件中整合。

### 3.3. 字典系统下一步工作
1.  **补充产品名称**: 将上述约20-25个真实产品补充到产品字典中。
2.  **完善经销商字典**: 将区域、省份等结构信息整合到经销商主字典。
3.  **验证NC和TB数据**: 解决数据库连接问题后，重新进行产品字典的覆盖验证。
4.  **处理同名产品**: 检查并处理同名但不同规格的产品。

---

## 4. 开发与环境信息

### 4.1. 数据库连接
*   **Docker容器名**: `mssql-server`
*   **镜像**: `mcr.microsoft.com/mssql/server:2022-latest`
*   **连接参数**:
    *   Server: `localhost,1433`
    *   User: `sa`
    *   Password: `MyNewPass123`
*   **macOS ODBC 驱动**: `msodbcsql17`

### 4.2. 常见问题与解决方案
*   **`sqlcmd` 连接失败 (SSL Error)**: 添加 `-C` (信任证书) 和 `-N` (加密连接) 参数。
*   **`sqlcmd` 跨库查询失败 (Collation Conflict)**: 在 `WHERE` 子句中添加 `COLLATE Chinese_PRC_CI_AS`。
*   **`.bak` 恢复失败 (Orphaned User)**: 通过 `ALTER AUTHORIZATION` 和 `DROP USER` 解决。