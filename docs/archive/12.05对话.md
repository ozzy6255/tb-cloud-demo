# 12.05 对话完整记录

**日期**: 2025-12-05
**记录对象**: 用户 (User) 与 Gemini (Assistant)

---

**User**: 早上好，列出我们今天的工作计划。我俩核对后再开始工作

**Gemini**: 早上好！昨天的深度排查为我们揭示了数据中隐藏的关键问题。

根据 `docs/00_项目主控文档.md` 和我们的讨论，今天的核心任务是 **“破案”** —— 找出 2022 年销售报表中“失踪”的经销商（特别是中芝），并完成最终的产销分析准备。

### 📅 今日工作计划 (12.05)

**Step 1: 鲁东区域大核查 (破案行动)**
*   **目标**: 找出 2022 年销售报表中，中芝的 9.9 万瓶酒到底记在了谁的头上。
*   **方法**:
    1.  从 `Dealer_Attribute_Mapping.csv` 中提取所有归属于 **“鲁东”** 区域的经销商名单。
    2.  分别在 Sales 和 TB 数据中，统计这些经销商在 2022 年的销量。
    3.  **对比寻找**: 是否存在某个“鲁东”大户，在 Sales 里有巨额销量，但在 TB 里销量很小（或者相反）？这个差额可能就是中芝。

**Step 2: 经销商字典最终修补**
*   **目标**: 根据 Step 1 的发现，修正字典映射。
*   **操作**: 如果发现中芝被合并到了“烟台荣华”或“山东君顶”，我们需要在字典中建立特殊的映射规则（或记录在案），以确保分析准确。

**Step 3: 启动产销平衡分析**
*   **目标**: 生成第一份全公司级别的产销对比报告。
*   **范围**: 2022-2024 全年。
*   **口径**:
    *   生产: 入库量 (Prod)。
    *   TB: `From='0'` 的出库量。
    *   Sales: 修正后的销售报表。

---

**您是否同意这个执行顺序？**
如果同意，我将从 **Step 1: 提取鲁东区域经销商名单** 开始。

---

**User**: 我先把我了解的实际业务情况和你沟通清楚，然后重新规划行动路径再开始。说明：1.四个数据库：除了生产的。其他都有经销商名单，也都列入了Dealer_Attribute_Mapping.csv。2、经销商归属是按照销售报表中的分配为基准的。但2.1鲁东在22年的销售报表中（销售原始报表）中的名称是"烟威" 并且下面只有三个加盟商的名字，而且这三个名字都不是我们真实的经销商，而是"平台"（相当于我仓库）。2.2鲁东在23年的销售报表中（原始销售报表）的名称是"鲁东"，共有37个加盟商，其中2个"烟台荣华"和"山东君顶"仍然是平台，其余的35个是真实的加盟商2.3鲁东在24年的销售报表中（销售原始报表）中的名称是"鲁东"，共25个加盟商，已经没有平台，都是真实的加盟商。     计划：我的计划（请帮我优化或提出建议）1、单独针对"鲁东开始核查。1.1生成一个鲁东加盟商字典的核对表：将鲁东所有的加盟商与tb nc的加盟商名称进行匹配（参考加盟商字典和加盟商归属字典）2、如果名称核对和归属100%完成，生成鲁东（真实经销商）三年的销售总量（tb nc 销售每个数据库三个数），我来人工核对。如果有问题，我们在展开细查，找出线索-破案。 请先分析我提供的线索，然后优化我的实施路径，确认后，在执行

**Gemini**: 您的业务背景信息非常关键，这解释了为什么 2022 年数据如此诡异。

**关键信息提取与分析**：

1.  **2022 年的“黑箱” (烟威区)**：
    *   销售报表中没有具体的经销商明细，只有 3 个“平台”账号。
    *   这意味着：**2022 年所有真实的经销商销量（包括中芝），在销售报表中都被汇总到了这 3 个平台名下**。
    *   **推论**: 我们永远无法从 2022 年的 *销售报表* 中拆分出“中芝”的具体销量。我们只能看到“烟威大区”的总量。
    *   **策略调整**: 对于 2022 年，我们只能做 **区域级 (Region Level)** 的对比，无法做 **经销商级 (Dealer Level)** 的对比。

2.  **2023 年的“混合态”**:
    *   有 35 个真实经销商 + 2 个平台。
    *   这说明部分销量已细化，部分可能仍挂在平台名下。

3.  **2024 年的“透明态”**:
    *   全部是真实经销商。这是数据质量最好的一年（也验证了我们昨天的中芝对账为何 2024 年如此精准）。

---

**优化后的实施路径 (针对“鲁东”战役)**

**阶段一：鲁东经销商全景映射 (1.1 的升级版)**
*   **目标**: 建立一份包含 **所有年份、所有身份** 的鲁东经销商清单。
*   **步骤**:
    1.  从 `Dealer_Attribute_Mapping.csv` 中提取所有 `Region = 鲁东` (或 `烟威`) 的记录。
    2.  **关键补充**: 同时从 2022/2023 年原始 Excel 中提取那几个“平台”的名字 (如 "烟威", "烟台荣华")，确保它们也在清单里。
    3.  将这些名字与 TB/NC 进行匹配，生成核对表。
    4.  **产出**: `scripts/ludong_dealer_mapping_check.csv` (包含：销售名, Master名, TB名, NC名, 是否平台)。

**阶段二：区域总量“大对账” (2 的升级版)**
*   **目标**: 验证“鲁东”这个大盘子在三年里是否对得上。
*   **逻辑**:
    *   **Sales**: 汇总所有属于“鲁东/烟威”的行（包括平台和散户）。
    *   **TB**: 汇总所有 **真实属于鲁东地区** 的经销商的进货量（这里需要我们手动或半自动给 TB 经销商打上“鲁东”标签，因为 TB 原生没有区域字段）。
    *   **NC**: 同 TB。
*   **预期结果**: 虽然 2022 年 Sales 只有 3 个平台，但它们加起来的总量，应该等于 TB 中几百个鲁东经销商的总进货量。如果对得上，说明**总账没乱**。

**您的计划 vs 优化计划**:
您的计划非常务实。我唯一的补充是 **TB/NC 端的区域标签打标**。因为 TB/NC 里没有 "Region" 字段，我们需要依靠 Dealer Master 中的 `Sales_Region` 属性来反推。
*   即：如果 TB 中的 `中芝` 映射到了 Master `中芝酒业`，而 `中芝酒业` 在属性表中属于 `鲁东`，那么这笔 TB 销量就归入 `鲁东`。

---

**执行指令确认**：
我们先执行 **阶段一：生成鲁东加盟商字典核对表**。

您同意吗？

**User**: 同意 执行

**Gemini**: (执行 `generate_ludong_check.py` 脚本)
已生成 **鲁东区域经销商核对表**：`scripts/ludong_dealer_mapping_check.csv` (共 44 条)。

**发现**:
*   区域名称为 `鲁东`，未发现 `烟威` (可能在属性表中已统一归类为鲁东)。
*   这 44 条是 Sales 报表中出现过的、归属鲁东的所有经销商（包括 2022、2023、2024 的集合）。

**您的任务**:
1.  下载 `scripts/ludong_dealer_mapping_check.csv`。
2.  在 `Is_Platform_or_Actual` 列中标注：
    *   `Platform`: 如果它是 2022/2023 年的汇总平台 (如 "烟台荣华", "山东君顶")。
    *   `Actual`: 真实经销商。
3.  **重点检查**: 看看是否有您之前提到的“烟威”这个名字？如果没有，可能它在属性表里被清洗掉了或者映射到了别处。

(注：如果您希望我也把 2022 年原始 Excel 里的“烟威”硬拽出来，我可以去扫描原始文件。但在 `Dealer_Attribute_Mapping` 里似乎没见到。)

---

**User**: 字典Dealer_Attribute_Mapping确实没有"烟威"。但在销售原始报表22年中 sheet 目录 a列 14-16行确实有"烟威"。说明前期生成字典的代码还是存在瑕疵。行动：把销售22年-24年的销售原始报表 sheet"目录"中经销商归属（a-d列）再重新计算一遍，纠正经销商归属字典后，再进行鲁东的核查。针对销售原始报表归属部分的具体说明：以下是有效部分，其他忽略，22年（a2-d114)；23年（a2-d148)；24年（a2-d176) 注意原始数据有空格继续

**Gemini**: 您的指正非常关键。这说明我们的 `Dealer_Attribute_Mapping.csv` 并不完整，漏掉了 2022/2023 年的一些关键节点（如“烟威”），而这些节点恰恰是“藏着”中芝等真实销量的平台。

我们将执行 **经销商归属字典的彻底重建**。

**行动计划**:

1.  **提取源数据 (Step 1)**:
    *   分别读取 2022, 2023, 2024 三个原始 Excel 的 `目录` Sheet。
    *   **精确范围锁定**:
        *   2022: A2:D114
        *   2023: A2:D148
        *   2024: A2:D176
    *   **字段映射**: 
        *   A列 -> Region (区域)
        *   B列 -> Province (省份)
        *   C列 -> ShortName (经销商)
        *   D列 -> FullName (全称)
    *   **清洗**: 去除空格，去除无效行。

2.  **合并与去重 (Step 2)**:
    *   将三年数据合并。
    *   如果 C 列里有 "烟威" 这个名字（作为平台），那它才会被放入属性表。

3.  **重建字典 (Step 3)**:
    *   生成新的 `Dealer_Attribute_Mapping.csv`。
    *   重新运行映射逻辑（Raw -> Master），确保所有新提取的 ShortName 都有对应的 Master。

我将先执行 **Step 1: 提取脚本**。

(执行 `reextract_dealer_attributes.py` 脚本)

**Step 1 完成：2022 年的“烟威”找到了！**

*   在 `reextracted_dealer_attributes.csv` 中：
    *   Row 13: Year=2022, Region=**烟威**, ShortName=**烟台新品** (?)
*   等等，您之前说“22年...下面只有三个加盟商”。
    *   脚本输出显示了 `烟台新品`，这可能是一个。

**下一步 (Step 2 & 3)**：
1.  **合并**: 将这份新提取的属性表 (`reextracted`) 合并到正式的 `Dealer_Attribute_Mapping.csv` 中。
2.  **重建映射**: 再次运行 `rebuild_dealer_dict.py`。
3.  **重新生成鲁东核查表**: 再次运行 `generate_ludong_check.py`。

我将先合并属性表，然后重建字典。

(执行 `update_dealer_attr_file.py` 脚本)
**属性表已更新**。

现在执行 **Step 3: 重建字典映射** (`rebuild_dealer_dict.py`)。
(执行 `rebuild_dealer_dict.py` 脚本)
**字典重建完成**。
*   **Unmapped Sales Dealers: 3**
    *   有 3 个 Sales 中的名字没有匹配到 Master。
    *   这很可能就是 2022 年那三个平台！

我将查看这 3 个未匹配的名字。
(执行 `check_unmapped_dealers.py` 脚本)

**破案了：未匹配的三个名字**
1.  **`加盟商` (区域=`区域`)**: 忽略。
2.  **`烟台新品` (区域=`烟威`)**: 这就是 2022 年的“平台”之一！
3.  **`宁波静悦` (区域=`浙东`)**: 这是另一个未匹配的经销商。

**接下来的操作**:
1.  将 `烟台新品` 和 `宁波静悦` 加入 Master Dictionary。
2.  重新运行 `rebuild_dealer_dict.py`。
3.  重新运行 `generate_ludong_check.py`。

我将先添加这两个 Master。
(执行 `add_missing_masters_ludong.py` 脚本)
**Master 已添加。**

现在我们需要 **重新运行 `rebuild_dealer_dict.py`**。
(执行 `rebuild_dealer_dict.py` 脚本)
**Unmapped Sales Dealers: 1** (只剩表头，修复完成)。

**现在执行 Step 1.1 (Original Plan): 生成鲁东核查表**
我将再次运行 `generate_ludong_check.py`。
(执行 `generate_ludong_check.py` 脚本)
**鲁东核查表 (`scripts/ludong_dealer_mapping_check.csv`) 已就绪！**

请下载并查看。
**重点关注**:
*   `烟台新品` (2022年平台?)
*   `烟台荣华` (2023年平台?)
*   `山东君顶` (平台?)

请在 `Is_Platform_or_Actual` 列标注，然后发回给我。

---

**User**: 我直接告诉你吧，就不用标注了。三个都是平台

**Gemini**: 收到。确认 **烟台新品、烟台荣华、山东君顶** 均为 **平台** (Platform)。

**现在进入 阶段二：区域总量大对账 (The Grand Reconciliation)**

我们需要验证：
**2022年 鲁东区 (包含 "烟台新品") 的总销量** 是否等于 **TB 中所有鲁东真实经销商的进货总量**。

**挑战**:
TB 数据库中没有“区域”字段。我们需要：
1.  找出 Sales 报表中归属 `鲁东` (含 `烟威`) 的所有 **真实经销商** 的名字。
2.  找到这些名字对应的 TB CustomerId。
3.  统计它们的 TB 进货量。
4.  同时，统计 Sales 报表中那 3 个平台 (`烟台新品`, `烟台荣华`, `山东君顶`) 的销量。
5.  **对比**: `SUM(TB_Real_Dealers) ≈ SUM(Sales_Platforms)` ?

**执行计划**:
编写 `scripts/reconcile_ludong_region.py`:
1.  **定义范围**:
    *   **Sales Platforms**: `['烟台新品', '烟台荣华', '山东君顶']`
    *   **Region**: `['鲁东', '烟威']`
2.  **获取 TB Dealer List**: 从 `Dealer_Attribute_Mapping.csv` 中筛选 Region 为鲁东的所有经销商 (排除掉那 3 个平台)，获取其 `Matched_Master_Name` -> `In_TB_DB`。
3.  **查询 TB**: 统计这些 dealers 在 2022 年的总进货量。
4.  **查询 Sales**: 统计 3 个平台在 2022 年的总销量。
5.  **输出**: 对比结果。

是否执行？

---

**User**: 执行。但如果我们在22年找不到答案（有可能是动态平衡）我们就从23 24年找，从销售 tb nc找，从某个单品找 从某个订单时间找（因为订单在实际中时贯穿四个数据库的）

**Gemini**: (执行 `reconcile_ludong_region.py` 脚本)
**严重警告：TB 映射为空！**
*   `Mapped to 0 TB Dealer Names.`
*   这导致 `TB(Real)` 销量全部为 0。

**原因分析**:
在脚本中，我使用 `df_master[mask_tb]['In_TB_DB']` 来获取 TB 名称。但是，之前 `rebuild_dealer_dict.py` 将 `In_TB_DB` 列置空了。

**修正方案**:
我们需要更智能的模糊匹配。我将修改 `reconcile_ludong_region.py`，增加一步：**如果 In_TB_DB 为空，尝试在 TB Customer 表中模糊搜索 Master Name**。

(执行修正后的 `reconcile_ludong_region.py` 脚本)
**鲁东对账结果 (2022-2024)**
1.  **2022年**: Sales 67.5万, TB 27.7万 (差异 39.8万)。
2.  **2024年**: Sales 64.0万, TB 9.8万 (差异 54.1万)。**这很不正常**。2024年中芝对账很准，为何区域对账差这么多？

**紧急核查**:
这 25 个匹配上的 TB 经销商是谁？中芝在里面吗？
我将修改脚本，打印出匹配到的 TB Names，以及未匹配到的 Real Masters。

(执行 Debug 版脚本)
**漏网之鱼清单 (Unmatched Masters)**
发现 22 个未匹配的 Master，包括大户 `烟台中芝`, `烟台三五七`, `烟台名庄荟`。
原因：Master Name (如 `烟台中芝`) 在 TB (如 `中芝酒业`) 中没有被模糊匹配逻辑捕获 (包含了长短名问题)。

**修复方案**:
我们需要手动修复这 22 个映射。请指示：我为您生成一个 `manual_fix_dealer_tb.csv`？

---

**User**: 修正：以销售库中属于鲁东的实际经销商为基准，将tb和nc中可能匹配的经销商（近似就可以，尽量不要遗漏），生成一个单独的表，我来人工确认

**Gemini**: 好的，这正是我们需要的。
我将为您生成 **`scripts/ludong_dealer_manual_match.csv`**。
**逻辑**:
1.  **基准**: Sales 中归属 "鲁东/烟威" 的 42 个真实经销商。
2.  **候选池**: TB 数据库的所有 CustomerName + NC 数据库的所有客户名称。
3.  **匹配**: 精确匹配 + 模糊匹配 + 包含匹配。

(执行 `generate_ludong_manual_match.py` 脚本)
**鲁东经销商人工匹配表已生成**。请您下载核对。

---

**User**: 补充问题：表中的 (Fuzzy) 和[Exact] 是什么意思？

**Gemini**:
**标记含义解释**：
1.  **`[Exact]`**: 完全一致。
2.  **`(Fuzzy)`**: 字符相似度高，但不同。
3.  **无标记**: 包含关系 (如 "中芝" 在 "山东中芝" 里)。

---

**User**: 在这个表上@scripts/ludong_dealer_manual_match.csv 增加一个信息以帮助我更准确的判断。增加信息：每个经销商的3年的总销量。销售 tb nc 都分别列上，如果一个销售对应了多个tb和nc的名称，请分别标注销量

**Gemini**: 这是一个非常棒的需求！有了销量数据，判断是否匹配就容易多了。
我将编写 `scripts/enrich_ludong_match.py`，为每个候选名附带 3 年总销量。

(执行 `enrich_ludong_match.py` 脚本)
**鲁东经销商核对表 (含销量版) 已生成！**
文件位置：`scripts/ludong_dealer_manual_match_enriched.csv`。

---

**User**: 补充侦查：我看到scripts/ludong_dealer_manual_match_enriched.csv`中 tb对应的"中芝"近似名称 是无。 请再次查询 tb数据库中没有'中芝"近似的经销商名称吗/

**Gemini**: 这是一个重要的遗漏。让我们**直接在 TB 数据库中搜索所有包含“中芝”字样的客户**。

(执行 SQL 查询)
**侦查结果**：
TB 数据库中确实只有 **2** 个包含“中芝”的名字：`山东君顶-中芝` 和 `中芝酒业`。

**为什么没显示？**
原因：原脚本的包含匹配逻辑失效 (Sales "烟台中芝" 和 TB "中芝酒业" 没有相互包含关系)。

**结论**：
Sales 里的 `烟台中芝`，肯定对应 TB 里的 `中芝酒业` (或 `山东君顶-中芝`)。

---

**User**: 我的问题，不仅仅是为什么没没哟中芝，而是会不会还漏掉了其他的？也就是说 你原来的代码没有找到中芝，现在的代码能找到中芝。差别是什么？会不会影响到除了"中芝"以外的其他名称或数据的核查，这个表不准确，我人工核对

**Gemini**: 您的担忧非常合理。如果代码连显而易见的“中芝”都漏掉了，那么其他经销商的匹配推荐可能也不可靠。

**改进方案**：
引入 **“分词匹配”** 机制。只要 Sales 名字中的核心词（去除“公司”、“商贸”等）在 TB 名字中出现，就列为候选。

我将 **重写并重新执行** 生成脚本 `generate_ludong_manual_match_v2.py`，确保 **宁可多列、绝不遗漏**。

(执行 `generate_ludong_manual_match_v2.py` 脚本)
**增强版核对表 (`scripts/ludong_dealer_manual_match_v2.csv`) 已生成。**
这次的匹配逻辑非常宽容。请您下载并确认。

---

**User**: 今天先进行到这里：1、重点内容放到 总备忘录2、所有对话（一句不少）存放到一个独立文件12.05对话md文件

**Gemini**: 好的，非常感谢您的耐心指导。
我将立即执行文档归档工作。
1.  更新 `docs/00_项目主控文档.md`。
2.  保存 `docs/历史归档/12.05对话.md`。

(执行文档归档操作)