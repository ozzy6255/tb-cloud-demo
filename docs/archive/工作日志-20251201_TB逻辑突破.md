# 工作日志 - 2025-12-01 (TB业务逻辑突破)

**日期**: 2025-12-01
**重点**: TB 溯源系统业务逻辑解码 & 产销分析口径确定

---

## 🕵️‍♂️ 侦探过程与重大发现

为了厘清“君顶国际”、“君顶酒业(山东)”与“经销商”之间的复杂流转关系，避免重复计算，我们进行了深度的数据库侦查。

### 1. 身份验证
*   **君顶国际**: 系统中不存在名为“君顶国际”的顶级公司实体。
*   **君顶国际酒业（山东）有限公司**: 系统中的核心节点。
*   **中芝酒业**: 其 `ParentId` 指向“君顶国际酒业（山东）有限公司”，确认为下级。

### 2. 业务操作解码
*   **OutType**: 前端代码证实 `0` = 出库(销售)，`1` = 退货。
*   **Storage**: 系统有仓库表但未启用多仓库管理（`StorageId` 均为 0 或 1），流向单一。

### 3. 货物流向之谜 (双路径证实)
通过追踪 `TBOut` 表，我们发现货物的源头是 `FromCustomerId = '0'` (代表生产线/源头)。

*   **路径 A (经平台)**:
    *   `'0'` -> `君顶国际酒业（山东）有限公司` (量最大，364万)
    *   `君顶国际酒业（山东）有限公司` -> `中芝酒业` (二次流转)
*   **路径 B (直发)**:
    *   `'0'` -> `山东谦儒商贸` (53万)
    *   `'0'` -> `济南君顶酒业` (57万)
    *   `'0'` -> `山东君顶-中芝` (43万)

**结论**: 确实存在大量经销商直接从生产源头拿货，跳过了“山东公司”这一层。

---

## 📊 产销分析统计口径 (The Golden Formula)

基于上述发现，我们确定了统计 **“TB系统出货量” (即公司一级销量)** 的唯一正确公式：

> **只统计 `TBOut` 表中 `FromCustomerId = '0'` 的记录。**

*   **准确性**: 统计了所有离开生产线进入流通环节的货物。
*   **去重性**: 完美避开了“平台 -> 经销商”的二次流转（因为二次流转的 From 是公司ID，不是 '0'）。
*   **完整性**: 同时覆盖了“发给平台备货”和“直发经销商”两种模式。

---

## 📝 待办事项

**明天 (12.02)**:
1.  **执行产销分析**: 基于 `From = '0'` 的逻辑，编写脚本生成 2022-2024 产销平衡报告。
2.  **维度**: 按年份、按产品对比“生产入库” vs “TB出货” vs “销售报表”。

